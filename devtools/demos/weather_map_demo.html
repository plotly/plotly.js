<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <title>Weather Map Demo - Custom Marker Functions</title>
    <script src="../../dist/plotly.js"></script>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        h1 { color: #333; }
        #weatherMap { width: 100%; max-width: 800px; height: 400px; }
        .legend { margin-top: 10px; font-size: 14px; }
    </style>
</head>
<body>
    <h1>Weather Map Demo</h1>
    <p>Custom marker functions with data-driven symbols: sun, cloud, and wind arrows.</p>
    <div id="weatherMap"></div>
    <div class="legend">
        <strong>Legend:</strong> Sun = sunny | Cloud = cloudy | Arrows = wind direction &amp; speed (more barbs = stronger)
    </div>

    <script>
    // Weather marker function: (r, customdata)
    function weatherMarker(r, customdata) {
        var weather = customdata;

        if (weather.type === 'sunny') {
            // Sun: circle with rays
            var cr = r * 0.5;
            var rayLen = r * 0.4;
            var path = 'M' + cr + ',0A' + cr + ',' + cr + ' 0 1,1 0,-' + cr +
                       'A' + cr + ',' + cr + ' 0 0,1 ' + cr + ',0Z';
            for (var i = 0; i < 8; i++) {
                var ang = i * Math.PI / 4;
                var x1 = (cr + 2) * Math.cos(ang);
                var y1 = (cr + 2) * Math.sin(ang);
                var x2 = (cr + rayLen) * Math.cos(ang);
                var y2 = (cr + rayLen) * Math.sin(ang);
                path += 'M' + x1.toFixed(2) + ',' + y1.toFixed(2) +
                        'L' + x2.toFixed(2) + ',' + y2.toFixed(2);
            }
            return path;
        }

        if (weather.type === 'cloudy') {
            // Cloud shape
            var cy = r * 0.2;
            return 'M' + (-r*0.6) + ',' + cy +
                   'A' + (r*0.35) + ',' + (r*0.35) + ' 0 1,1 ' + (-r*0.1) + ',' + (-cy) +
                   'A' + (r*0.4) + ',' + (r*0.4) + ' 0 1,1 ' + (r*0.5) + ',' + (-cy*0.5) +
                   'A' + (r*0.3) + ',' + (r*0.3) + ' 0 1,1 ' + (r*0.7) + ',' + cy +
                   'L' + (-r*0.6) + ',' + cy + 'Z';
        }

        if (weather.type === 'wind') {
            // Simple wind barb: staff with 1-3 barbs based on speed
            var speed = weather.speed || 1;
            var barbs = Math.min(speed, 3);  // max 3 barbs
            var staffLen = r * 1.2;
            var barbLen = r * 0.6;
            var barbSpacing = r * 0.3;

            // Staff pointing up (rotation handled by marker.angle)
            var path = 'M0,' + staffLen + 'L0,-' + staffLen;
            var y = -staffLen;

            // Add barbs
            for (var i = 0; i < barbs; i++) {
                path += 'M0,' + y + 'L' + barbLen + ',' + (y + barbSpacing);
                y += barbSpacing;
            }

            return path;
        }

        // Default: circle
        return 'M' + r + ',0A' + r + ',' + r + ' 0 1,1 0,-' + r +
               'A' + r + ',' + r + ' 0 0,1 ' + r + ',0Z';
    }

    // Cities with weather + wind arrows forming a jet stream pattern (W to E, curving south)
    var locations = [
        // Cities
        { name: 'Seattle', lon: -122, lat: 47, weather: { type: 'cloudy' } },
        { name: 'San Francisco', lon: -122, lat: 38, weather: { type: 'sunny' } },
        { name: 'Denver', lon: -105, lat: 40, weather: { type: 'sunny' } },
        { name: 'Chicago', lon: -88, lat: 42, weather: { type: 'cloudy' } },
        { name: 'New York', lon: -74, lat: 41, weather: { type: 'cloudy' } },
        { name: 'Miami', lon: -80, lat: 26, weather: { type: 'sunny' } },
        { name: 'Dallas', lon: -97, lat: 33, weather: { type: 'sunny' } },
        // Wind arrows - jet stream curving from NW to SE
        { name: 'E 3', lon: -115, lat: 46, weather: { type: 'wind', direction: 100, speed: 3 } },
        { name: 'ESE 3', lon: -108, lat: 44, weather: { type: 'wind', direction: 110, speed: 3 } },
        { name: 'SE 2', lon: -100, lat: 42, weather: { type: 'wind', direction: 120, speed: 2 } },
        { name: 'SE 2', lon: -93, lat: 39, weather: { type: 'wind', direction: 130, speed: 2 } },
        { name: 'SSE 1', lon: -85, lat: 36, weather: { type: 'wind', direction: 150, speed: 1 } },
        { name: 'S 1', lon: -78, lat: 33, weather: { type: 'wind', direction: 170, speed: 1 } }
    ];

    var x = locations.map(function(l) { return l.lon; });
    var y = locations.map(function(l) { return l.lat; });
    var customdata = locations.map(function(l) { return l.weather; });
    var text = locations.map(function(l) { return l.name; });

    var colors = locations.map(function(l) {
        if (l.weather.type === 'sunny') return '#FFD700';
        if (l.weather.type === 'cloudy') return '#708090';
        if (l.weather.type === 'wind') return '#4169E1';
        return '#333';
    });

    var angles = locations.map(function(l) {
        return l.weather.type === 'wind' ? l.weather.direction : 0;
    });

    Plotly.newPlot('weatherMap', [{
        type: 'scatter',
        mode: 'markers+text',
        x: x,
        y: y,
        customdata: customdata,
        text: text,
        textposition: 'bottom center',
        hoverinfo: 'text',
        marker: {
            symbol: weatherMarker,
            size: 30,
            color: colors,
            line: { width: 2, color: '#333' },
            angle: angles
        }
    }], {
        title: 'Weather Map Demo',
        xaxis: { title: 'Longitude', range: [-130, -70], gridcolor: '#ddd' },
        yaxis: { title: 'Latitude', range: [20, 52], scaleanchor: 'x', gridcolor: '#ddd' },
        showlegend: false,
        margin: { l: 50, r: 20, t: 40, b: 40 },
        paper_bgcolor: '#f8f8f8',
        plot_bgcolor: '#e8f4f8'
    });
    </script>
</body>
</html>
